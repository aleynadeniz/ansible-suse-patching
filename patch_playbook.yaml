---
- name: SLES 15 SP6 Full Update (Kernel Guaranteed)
  hosts: suse_hosts
  become: yes
  serial: 1

  tasks:
    - name: Kernel version before
      command: uname -r
      register: pre_kernel
      changed_when: false

    - name: Run full dist-upgrade (dup)
      zypper:
        name: '*'
        state: dist-upgrade
        extra_args: '--auto-agree-with-licenses'
      register: zypper_result

    # Çözüm: zypper ps (veya zypper-needs-restarting) kullanarak kontrol etme
    - name: Check if reboot is required (zypper ps)
      command: zypper ps -s
      register: reboot_required
      failed_when: false
      changed_when: false

    - name: Reboot the server if kernel or libraries updated
      reboot:
        reboot_timeout: 1800
      # Eğer zypper 102 döndüyse VEYA zypper ps içinde reboot mesajı varsa reboot et
      when: (zypper_result.rc == 102) or ('reboot' in reboot_required.stdout.lower())

    - name: Kernel version after
      command: uname -r
      register: post_kernel
      changed_when: false

    - name: Summary
      debug:
        msg:
          - "Kernel before: {{ pre_kernel.stdout }}"
          - "Kernel after : {{ post_kernel.stdout }}"
          - "Status: {{ 'UPDATED & REBOOTED' if pre_kernel.stdout != post_kernel.stdout else 'NO KERNEL CHANGE' }}"
