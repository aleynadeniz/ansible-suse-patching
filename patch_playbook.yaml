---
- name: SLES 15 SP6 Patch via SCC (GUI Safe)
  hosts: suse_hosts
  become: yes
  serial: 1

  vars:
    reboot_timeout: 1800

  tasks:

    - name: Check PackageHub status
      command: SUSEConnect --status-text
      register: scc_status
      changed_when: false

    - name: Attach PackageHub if missing
      command: SUSEConnect -p PackageHub/15.6/x86_64
      when: "'PackageHub 15 SP6 x86_64' not in scc_status.stdout"
      register: phub_attach
      failed_when: false

    - name: Refresh repositories
      command: zypper --non-interactive refresh
      changed_when: false

    - name: Apply patches
      command: >
        zypper --non-interactive patch
        --auto-agree-with-licenses
        --no-recommends
        --skip-interactive
      register: patch_result
      failed_when: patch_result.rc not in [0,102,4]
      changed_when: "'Nothing to do.' not in patch_result.stdout"

    - name: Reboot if required
      reboot:
        reboot_timeout: "{{ reboot_timeout }}"
        msg: "Reboot after patching"
      when: patch_result.rc == 102

    - name: Show result
      debug:
        msg:
          - "Return code: {{ patch_result.rc }}"
          - "Reboot required: {{ patch_result.rc == 102 }}"
