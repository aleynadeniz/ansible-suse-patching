---
- name: SUSE Toplu Yama (Patch) ve Kernel Kontrol Yönetimi
  hosts: suse_hosts
  become: yes
  serial: "100%"   # Aynı anda tüm hostlar (istersen 1 yapabilirsin)

  vars:
    reboot_timeout: 1200

  tasks:

    # --- 1. ADIM: İŞLEM ÖNCESİ DURUM ---
    - name: 1.1. Mevcut (Eski) Kernel sürümünü kaydet
      ansible.builtin.command: uname -r
      register: pre_kernel
      changed_when: false

    - name: 1.2. Bekleyen yama listesini kontrol et (bilgi amaçlı)
      ansible.builtin.command: zypper list-patches
      register: patch_list_before
      changed_when: false

    - name: 1.3. Patch listesi (öncesi)
      ansible.builtin.debug:
        var: patch_list_before.stdout_lines

    # --- 2. ADIM: YAMA UYGULAMA ---
    - name: 2.1. Tüm onaylı yamaları yükle (zypper patch)
      ansible.builtin.command: zypper patch -y
      register: patch_result
      changed_when: "'Nothing to do.' not in patch_result.stdout"

    # --- 3. ADIM: REBOOT GEREKLİLİK KONTROLÜ ---
    - name: 3.1. Reboot gerekiyor mu kontrol et
      ansible.builtin.shell: zypper ps -s | grep -qi restart
      register: reboot_needed
      failed_when: false
      changed_when: false

    # --- 4. ADIM: AKILLI REBOOT ---
    - name: 4.1. Yama yüklendiyse veya reboot gerekiyorsa yeniden başlat
      ansible.builtin.reboot:
        reboot_timeout: "{{ reboot_timeout }}"
        msg: "Ansible patching sonrası sistem yeniden başlatılıyor."
      when: reboot_needed.rc == 0 or patch_result.changed

    - name: 4.2. Reboot sonrası bağlantıyı bekle
      ansible.builtin.wait_for_connection:
        timeout: "{{ reboot_timeout }}"
      when: reboot_needed.rc == 0 or patch_result.changed

    # --- 5. ADIM: İŞLEM SONRASI DURUM ---
    - name: 5.1. Güncel (Yeni) Kernel sürümünü al
      ansible.builtin.command: uname -r
      register: post_kernel
      changed_when: false

    - name: 5.2. Patch listesi (sonrası)
      ansible.builtin.command: zypper list-patches
      register: patch_list_after
      changed_when: false

    # --- 6. ADIM: FİNAL RAPOR ---
    - name: 6.1. FİNAL ÖZET RAPORU
      ansible.builtin.debug:
        msg:
          - "--------------------------------------------------"
          - "SUNUCU: {{ inventory_hostname }}"
          - "ÖNCESİ KERNEL: {{ pre_kernel.stdout }}"
          - "SONRASI KERNEL: {{ post_kernel.stdout }}"
          - "KERNEL DURUMU: {% if pre_kernel.stdout != post_kernel.stdout %}YENİ KERNEL AKTİF{% else %}KERNEL DEĞİŞMEDİ{% endif %}"
          - "YAMA DURUMU: {% if patch_result.changed %}YAMALAR YÜKLENDİ{% else %}SİSTEM ZATEN GÜNCELDİ{% endif %}"
          - "--------------------------------------------------"
